<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Xelloxx Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#080c14;--bg2:#0d1525;--card:#111827;--border:rgba(255,150,0,0.15);--accent:#ff6a00;--accent2:#ff9500;--text:#e8eaf0;--muted:#8892a4;--sidebar:160px}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;min-height:100vh;display:flex}

/* SIDEBAR */
.sidebar{width:var(--sidebar);min-height:100vh;background:var(--bg2);border-right:1px solid var(--border);padding:1.5rem 0;display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:50}
.sidebar-logo{padding:0 1.2rem 1.5rem;font-size:1.2rem;font-weight:800;border-bottom:1px solid var(--border)}
.sidebar-logo span{color:var(--accent)}
.sidebar-nav{flex:1;padding:1rem 0}
.nav-item{display:flex;align-items:center;gap:.7rem;padding:.7rem 1.2rem;cursor:pointer;color:var(--muted);font-size:.85rem;transition:.2s;border-left:3px solid transparent;text-decoration:none}
.nav-item:hover,.nav-item.active{color:var(--text);background:rgba(255,106,0,.08);border-left-color:var(--accent)}
.nav-item .icon{font-size:1rem;width:20px;text-align:center}
.sidebar-bottom{padding:1rem 1.2rem;border-top:1px solid var(--border)}
.admin-info{font-size:.8rem;color:var(--muted);margin-bottom:.7rem}
.admin-info strong{color:var(--text);display:block}
.btn-logout{width:100%;padding:.5rem;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#ef4444;border-radius:8px;cursor:pointer;font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;transition:.2s}
.btn-logout:hover{background:rgba(239,68,68,.2)}

/* MAIN */
.main{margin-left:var(--sidebar);flex:1;min-height:100vh}
.topbar{padding:1.2rem 2rem;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.topbar h2{font-size:1.2rem;font-weight:700}
.topbar-right{display:flex;gap:.7rem;align-items:center}
.btn{padding:.5rem 1.1rem;border-radius:8px;font-family:'Syne',sans-serif;font-weight:700;cursor:pointer;transition:.2s;font-size:.85rem;border:none}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent2)}
.btn-sm{padding:.35rem .8rem;font-size:.78rem}
.btn-danger{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#ef4444}
.btn-danger:hover{background:rgba(239,68,68,.2)}
.btn-edit{background:rgba(99,102,241,.1);border:1px solid rgba(99,102,241,.3);color:#818cf8}
.btn-edit:hover{background:rgba(99,102,241,.2)}

/* CONTENT */
.content{padding:2rem}
.page{display:none}
.page.active{display:block}

/* STATS CARDS */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1.2rem;margin-bottom:2rem}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1.5rem}
.stat-card .s-icon{font-size:1.8rem;margin-bottom:.8rem}
.stat-card .s-val{font-size:2rem;font-weight:800;font-family:'Space Mono',monospace;color:var(--accent)}
.stat-card .s-label{font-size:.8rem;color:var(--muted);margin-top:.2rem}

/* TABLE */
.table-wrap{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.table-header{padding:1rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem}
.table-header h3{font-size:1rem;font-weight:700}
table{width:100%;border-collapse:collapse}
th{padding:.8rem 1.2rem;text-align:left;font-size:.75rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);font-family:'Space Mono',monospace}
td{padding:.9rem 1.2rem;font-size:.85rem;border-bottom:1px solid rgba(255,150,0,.05)}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(255,106,0,.03)}
.badge{display:inline-block;padding:.2rem .6rem;border-radius:100px;font-size:.7rem;font-family:'Space Mono',monospace;font-weight:700}
.badge-online{background:rgba(16,185,129,.15);color:#34d399;border:1px solid rgba(16,185,129,.3)}
.badge-offline{background:rgba(239,68,68,.1);color:#f87171;border:1px solid rgba(239,68,68,.2)}
.badge-rent{background:rgba(99,102,241,.15);color:#818cf8}
.badge-sell{background:rgba(16,185,129,.15);color:#34d399}
.td-img{width:48px;height:36px;object-fit:cover;border-radius:6px}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(10px);z-index:200;display:flex;align-items:center;justify-content:center;padding:1rem;opacity:0;pointer-events:none;transition:.3s}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--card);border:1px solid var(--border);border-radius:20px;width:100%;max-width:580px;max-height:90vh;overflow-y:auto;transform:translateY(20px);transition:.3s}
.modal-overlay.open .modal{transform:translateY(0)}
.modal-head{padding:1.2rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-head h3{font-size:1rem;font-weight:700}
.modal-body-inner{padding:1.5rem}
.form-row{margin-bottom:1rem}
.form-row label{display:block;font-size:.8rem;color:var(--muted);margin-bottom:.4rem;font-family:'Space Mono',monospace}
.form-row input,.form-row textarea,.form-row select{width:100%;padding:.7rem 1rem;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Syne',sans-serif;font-size:.9rem;outline:none;transition:.2s}
.form-row input:focus,.form-row textarea:focus,.form-row select:focus{border-color:var(--accent)}
.form-row textarea{resize:vertical;min-height:100px}
.form-row select option{background:var(--card)}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.modal-footer{padding:1rem 1.5rem;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:.7rem}
.btn-close{background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--text)}

/* TOAST */
.toast{position:fixed;bottom:2rem;right:2rem;background:#10b981;color:#fff;padding:.8rem 1.5rem;border-radius:10px;font-weight:700;font-size:.9rem;z-index:9999;transform:translateY(100px);opacity:0;transition:.3s}
.toast.show{transform:translateY(0);opacity:1}

/* SEARCH */
.search-inline{padding:.5rem .9rem;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Syne',sans-serif;font-size:.85rem;outline:none;min-width:200px}
.search-inline:focus{border-color:var(--accent)}

/* AUTH SCREEN */
#authScreen{position:fixed;inset:0;background:var(--bg);z-index:500;display:flex;align-items:center;justify-content:center}
.auth-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:2.5rem;width:100%;max-width:400px;text-align:center}
.auth-logo{font-size:2rem;font-weight:800;margin-bottom:0.3rem}
.auth-logo span{color:var(--accent)}
.auth-sub{color:var(--muted);font-size:.9rem;margin-bottom:2rem}
.auth-form .form-row{text-align:left}
.auth-btn{width:100%;margin-top:1rem}
.auth-error{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#f87171;padding:.7rem;border-radius:8px;font-size:.85rem;margin-bottom:1rem;display:none}

@media(max-width:768px){
.sidebar{width:100%;min-height:auto;position:relative;flex-direction:row;flex-wrap:wrap}
.main{margin-left:0}
.sidebar-nav{display:flex;flex-direction:row;overflow-x:auto;padding:.5rem}
.nav-item{border-left:none;border-bottom:2px solid transparent;white-space:nowrap}
.nav-item.active{border-bottom-color:var(--accent)}
}
</style>
</head>
<body>

<!-- AUTH -->
<div id="authScreen">
  <div class="auth-card">
    <div class="auth-logo">Xell<span>o</span>xx</div>
    <div class="auth-sub">Admin Panel â€” ÄÄƒng nháº­p Ä‘á»ƒ tiáº¿p tá»¥c</div>
    <div class="auth-error" id="authErr"></div>
    <div class="auth-form">
      <div class="form-row"><label>TÃªn Ä‘Äƒng nháº­p</label><input type="text" id="aUser" placeholder="admin"></div>
      <div class="form-row"><label>Máº­t kháº©u</label><input type="password" id="aPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')adminLogin()"></div>
      <button class="btn btn-primary auth-btn" onclick="adminLogin()">ÄÄƒng nháº­p â†’</button>
    </div>
  </div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-logo">Xell<span>o</span>xx <span style="font-size:.65rem;color:var(--muted);font-weight:400">Admin</span></div>
  <nav class="sidebar-nav">
    <a class="nav-item active" data-page="dashboard" onclick="showPage('dashboard',this)"><span class="icon">ğŸ“Š</span> Dashboard</a>
    <a class="nav-item" data-page="products" onclick="showPage('products',this)"><span class="icon">ğŸ“¦</span> Sáº£n pháº©m</a>
    <a class="nav-item" data-page="orders" onclick="showPage('orders',this)"><span class="icon">ğŸ›’</span> ÄÆ¡n hÃ ng</a>
    <a class="nav-item" data-page="users" onclick="showPage('users',this)"><span class="icon">ğŸ‘¥</span> NgÆ°á»i dÃ¹ng</a>
    <a class="nav-item" data-page="categories" onclick="showPage('categories',this)"><span class="icon">ğŸ·ï¸</span> Danh má»¥c</a>
    <a class="nav-item" data-page="mbbank" onclick="showPage('mbbank',this)"><span class="icon">ğŸ¦</span> MB Bank</a>
    <a class="nav-item" href="/" target="_blank"><span class="icon">ğŸŒ</span> Xem web</a>
  </nav>
  <div class="sidebar-bottom">
    <div class="admin-info"><strong id="adminName">Admin</strong>Quáº£n trá»‹ viÃªn</div>
    <button class="btn-logout" onclick="logout()">ÄÄƒng xuáº¥t</button>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <h2 id="pageTitle">ğŸ“Š Dashboard</h2>
    <div class="topbar-right">
      <button class="btn btn-primary btn-sm" id="topAction" style="display:none" onclick="openAddModal()">+ ThÃªm sáº£n pháº©m</button>
    </div>
  </div>

  <div class="content">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="stats-grid" id="dashStats"></div>
      <div class="table-wrap">
        <div class="table-header"><h3>ğŸ“¦ Sáº£n pháº©m gáº§n Ä‘Ã¢y</h3></div>
        <table><thead><tr><th>áº¢nh</th><th>TÃªn</th><th>Danh má»¥c</th><th>GiÃ¡</th><th>Loáº¡i</th><th>LÆ°á»£t xem</th></tr></thead>
        <tbody id="recentProducts"></tbody></table>
      </div>
    </div>

    <!-- PRODUCTS -->
    <div class="page" id="page-products">
      <div class="table-wrap">
        <div class="table-header">
          <h3>ğŸ“¦ Quáº£n lÃ½ sáº£n pháº©m</h3>
          <div style="display:flex;gap:.7rem;align-items:center">
            <input type="text" class="search-inline" id="prodSearch" placeholder="TÃ¬m kiáº¿m..." oninput="filterProdTable()">
            <button class="btn btn-primary btn-sm" onclick="openAddModal()">+ ThÃªm má»›i</button>
          </div>
        </div>
        <table><thead><tr><th>áº¢nh</th><th>TÃªn</th><th>Danh má»¥c</th><th>GiÃ¡</th><th>Loáº¡i</th><th>LÆ°á»£t xem</th><th>NgÃ y táº¡o</th><th>HÃ nh Ä‘á»™ng</th></tr></thead>
        <tbody id="productsTable"></tbody></table>
      </div>
    </div>

    <!-- ORDERS -->
    <div class="page" id="page-orders">
      <div class="table-wrap">
        <div class="table-header"><h3>ğŸ›’ Quáº£n lÃ½ Ä‘Æ¡n hÃ ng</h3></div>
        <table><thead><tr><th>MÃ£ Ä‘Æ¡n</th><th>Sáº£n pháº©m</th><th>KhÃ¡ch hÃ ng</th><th>Sá»‘ tiá»n</th><th>Tráº¡ng thÃ¡i</th><th>NgÃ y</th></tr></thead>
        <tbody id="ordersTable"></tbody></table>
      </div>
    </div>

    <!-- USERS -->
    <div class="page" id="page-users">
      <div class="table-wrap">
        <div class="table-header"><h3>ğŸ‘¥ Quáº£n lÃ½ ngÆ°á»i dÃ¹ng</h3></div>
        <table><thead><tr><th>Username</th><th>Email</th><th>Sá»‘ dÆ°</th><th>NgÃ y Ä‘Äƒng kÃ½</th></tr></thead>
        <tbody id="usersTable"></tbody></table>
      </div>
    </div>

    <!-- CATEGORIES -->
    <div class="page" id="page-categories">
      <div class="table-wrap">
        <div class="table-header">
          <h3>ğŸ·ï¸ Danh má»¥c</h3>
          <div style="display:flex;gap:.7rem">
            <input type="text" class="search-inline" id="catInput" placeholder="TÃªn danh má»¥c má»›i...">
            <button class="btn btn-primary btn-sm" onclick="addCategory()">+ ThÃªm</button>
          </div>
        </div>
        <table><thead><tr><th>TÃªn danh má»¥c</th><th>HÃ nh Ä‘á»™ng</th></tr></thead>
        <tbody id="catTable"></tbody></table>
      </div>
    </div>


    <!-- MB BANK SETTINGS -->
    <div class="page" id="page-mbbank">
      <div class="table-wrap" style="max-width:620px">
        <div class="table-header">
          <h3>ğŸ¦ CÃ i Ä‘áº·t MB Bank</h3>
        </div>
        <div style="padding:1.2rem;display:flex;flex-direction:column;gap:1rem;">
          <div style="background:rgba(251,191,36,.07);border:1px solid rgba(251,191,36,.2);border-radius:10px;padding:.9rem;font-size:.82rem;color:#fbbf24;line-height:1.6">
            âš ï¸ <strong>LÆ°u Ã½:</strong> ÄÃ¢y lÃ  API khÃ´ng chÃ­nh thá»©c cá»§a MB Bank. Cáº§n cÃ i <code>pip install mbbank-lib</code> trÃªn server. NÃªn dÃ¹ng tÃ i khoáº£n phá»¥ riÃªng Ä‘á»ƒ nháº­n tiá»n.
          </div>
          <div class="form-row">
            <label>KÃ­ch hoáº¡t tá»± Ä‘á»™ng</label>
            <label style="display:flex;align-items:center;gap:.5rem;cursor:pointer">
              <input type="checkbox" id="mbEnabled" style="width:18px;height:18px;accent-color:var(--accent)"/>
              <span style="font-size:.85rem;color:var(--muted)">Báº­t polling giao dá»‹ch MB Bank tá»± Ä‘á»™ng</span>
            </label>
          </div>
          <div class="form-row"><label>SÄT Ä‘Äƒng nháº­p MB</label>
            <input type="text" class="form-input" id="mbUsername" placeholder="Sá»‘ Ä‘iá»‡n thoáº¡i Ä‘Äƒng nháº­p MB Bank"/></div>
          <div class="form-row"><label>Máº­t kháº©u MB</label>
            <input type="password" class="form-input" id="mbPassword" placeholder="Äá»ƒ trá»‘ng = khÃ´ng thay Ä‘á»•i"/></div>
          <div class="form-row"><label>Sá»‘ TK nháº­n tiá»n</label>
            <input type="text" class="form-input" id="mbAccount" placeholder="Sá»‘ tÃ i khoáº£n hiá»ƒn thá»‹ cho khÃ¡ch"/></div>
          <div class="form-row"><label>TÃªn chá»§ TK</label>
            <input type="text" class="form-input" id="mbHolder" placeholder="NGUYEN VAN A"/></div>
          <div class="form-row"><label>TÃªn ngÃ¢n hÃ ng</label>
            <input type="text" class="form-input" id="mbBankName" value="MB Bank"/></div>
          <div style="display:flex;gap:.7rem;flex-wrap:wrap">
            <button class="btn btn-primary" onclick="saveMbSettings()">ğŸ’¾ LÆ°u cÃ i Ä‘áº·t</button>
            <button class="btn btn-outline" onclick="testMbConnection()">ğŸ”Œ Test káº¿t ná»‘i</button>
          </div>
          <div id="mbTestResult" style="display:none;padding:.8rem;border-radius:8px;font-size:.85rem;"></div>
          <hr style="border:none;border-top:1px solid var(--border);margin:.5rem 0"/>
          <h4 style="font-size:.9rem;font-weight:700">ğŸ“‹ YÃªu cáº§u náº¡p tiá»n gáº§n Ä‘Ã¢y</h4>
          <div style="overflow-x:auto">
          <table><thead><tr><th>User</th><th>MÃ£</th><th>Sá»‘ tiá»n</th><th>Xu</th><th>Tráº¡ng thÃ¡i</th><th>Thá»i gian</th></tr></thead>
          <tbody id="topupTable"></tbody></table>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- PRODUCT MODAL -->
<div class="modal-overlay" id="prodModal">
  <div class="modal">
    <div class="modal-head">
      <h3 id="modalTitle">ThÃªm sáº£n pháº©m má»›i</h3>
      <button class="btn btn-close btn-sm" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body-inner">
      <input type="hidden" id="editId">
      <div class="form-row"><label>TÃªn sáº£n pháº©m *</label><input type="text" id="fName" placeholder="TÃªn sáº£n pháº©m"></div>
      <div class="form-row"><label>MÃ´ táº£</label><textarea id="fDesc" placeholder="MÃ´ táº£ chi tiáº¿t..."></textarea></div>
      <div class="form-grid">
        <div class="form-row"><label>GiÃ¡ gá»‘c (Ä‘)</label><input type="number" id="fPrice" placeholder="0"></div>
        <div class="form-row"><label>GiÃ¡ sale (Ä‘, 0=khÃ´ng sale)</label><input type="number" id="fSale" placeholder="0"></div>
      </div>
      <div class="form-grid">
        <div class="form-row"><label>Danh má»¥c</label>
          <select id="fCat"></select>
        </div>
        <div class="form-row"><label>Loáº¡i</label>
          <select id="fType">
            <option value="sell">ğŸ›’ BÃ¡n file</option>
            <option value="rent">â± Cho thuÃª bot</option>
          </select>
        </div>
      </div>
      <div class="form-row"><label>URL áº¢nh</label><input type="text" id="fImg" placeholder="https://..."></div>
      <div class="form-row"><label>URL File / Link táº£i</label><input type="text" id="fFile" placeholder="https://..."></div>
      <div class="form-grid">
        <div class="form-row"><label>Sá»‘ lÆ°á»£ng (-1=khÃ´ng giá»›i háº¡n)</label><input type="number" id="fStock" value="-1"></div>
        <div class="form-row"><label>Ná»•i báº­t</label>
          <select id="fFeatured"><option value="0">KhÃ´ng</option><option value="1">CÃ³</option></select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-close" onclick="closeModal()">Há»§y</button>
      <button class="btn btn-primary" onclick="saveProduct()">ğŸ’¾ LÆ°u sáº£n pháº©m</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let adminUser = null;
let products = [];
let categories = [];

async function adminLogin(){
  const u=document.getElementById('aUser').value;
  const p=document.getElementById('aPass').value;
  const r=await fetch('/api/admin/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
  const d=await r.json();
  if(d.ok){
    adminUser=u;
    document.getElementById('authScreen').style.display='none';
    document.getElementById('adminName').textContent=u;
    initAdmin();
  } else {
    const e=document.getElementById('authErr');
    e.textContent=d.msg||'Lá»—i Ä‘Äƒng nháº­p';
    e.style.display='block';
  }
}

async function checkAuth(){
  const r=await fetch('/api/admin/check');
  const d=await r.json();
  if(d.ok){
    adminUser=d.username;
    document.getElementById('authScreen').style.display='none';
    document.getElementById('adminName').textContent=d.username;
    initAdmin();
  }
}

async function logout(){
  await fetch('/api/admin/logout');
  location.reload();
}

async function initAdmin(){
  await loadCategories();
  loadDashboard();
}

function showPage(name,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  if(el)el.classList.add('active');
  const titles={dashboard:'ğŸ“Š Dashboard',products:'ğŸ“¦ Sáº£n pháº©m',orders:'ğŸ›’ ÄÆ¡n hÃ ng',users:'ğŸ‘¥ NgÆ°á»i dÃ¹ng',categories:'ğŸ·ï¸ Danh má»¥c',mbbank:'ğŸ¦ MB Bank'};
  document.getElementById('pageTitle').textContent=titles[name]||name;
  document.getElementById('topAction').style.display=name==='products'?'inline-block':'none';
  if(name==='dashboard')loadDashboard();
  if(name==='products')loadProducts();
  if(name==='orders')loadOrders();
  if(name==='users')loadUsers();
  if(name==='categories')loadCatTable();
  if(name==='mbbank')loadMbSettings();
}

async function loadDashboard(){
  const r=await fetch('/api/admin/stats');
  const d=await r.json();
  document.getElementById('dashStats').innerHTML=`
    <div class="stat-card"><div class="s-icon">ğŸ“¦</div><div class="s-val">${d.products}</div><div class="s-label">Sáº£n pháº©m</div></div>
    <div class="stat-card"><div class="s-icon">ğŸ‘¥</div><div class="s-val">${d.users}</div><div class="s-label">NgÆ°á»i dÃ¹ng</div></div>
    <div class="stat-card"><div class="s-icon">ğŸ›’</div><div class="s-val">${d.orders}</div><div class="s-label">ÄÆ¡n hÃ ng</div></div>
    <div class="stat-card"><div class="s-icon">ğŸ’°</div><div class="s-val">${fmt(d.revenue)}Ä‘</div><div class="s-label">Doanh thu</div></div>`;
  const pr=await fetch('/api/admin/products');
  products=await pr.json();
  const recent=products.slice(-5).reverse();
  document.getElementById('recentProducts').innerHTML=recent.map(p=>`
    <tr>
      <td>${p.image?`<img src="${p.image}" class="td-img" alt="">`:'-'}</td>
      <td style="max-width:200px"><strong>${p.name}</strong></td>
      <td>${p.category}</td>
      <td style="font-family:'Space Mono',monospace;color:var(--accent)">${fmt(p.sale_price||p.price)}Ä‘</td>
      <td><span class="badge badge-${p.type}">${p.type==='rent'?'ThuÃª':'BÃ¡n'}</span></td>
      <td>${p.views||0}</td>
    </tr>`).join('');
}

async function loadProducts(){
  const r=await fetch('/api/admin/products');
  products=await r.json();
  renderProdTable(products);
}

function renderProdTable(data){
  document.getElementById('productsTable').innerHTML=data.map(p=>`
    <tr>
      <td>${p.image?`<img src="${p.image}" class="td-img" alt="">`:'-'}</td>
      <td style="max-width:180px"><strong>${p.name}</strong></td>
      <td>${p.category}</td>
      <td style="font-family:'Space Mono',monospace;color:var(--accent)">${fmt(p.price)}Ä‘${p.sale_price?` â†’ ${fmt(p.sale_price)}Ä‘`:''}</td>
      <td><span class="badge badge-${p.type}">${p.type==='rent'?'ThuÃª':'BÃ¡n'}</span></td>
      <td>${p.views||0}</td>
      <td style="font-size:.75rem;color:var(--muted)">${p.created_at}</td>
      <td>
        <button class="btn btn-edit btn-sm" onclick="editProduct('${p.id}')">Sá»­a</button>
        <button class="btn btn-danger btn-sm" onclick="deleteProduct('${p.id}')">XÃ³a</button>
      </td>
    </tr>`).join('');
}

function filterProdTable(){
  const q=document.getElementById('prodSearch').value.toLowerCase();
  renderProdTable(products.filter(p=>p.name.toLowerCase().includes(q)||p.category.toLowerCase().includes(q)));
}

async function loadOrders(){
  const r=await fetch('/api/admin/orders');
  const orders=await r.json();
  const tb=document.getElementById('ordersTable');
  if(!orders.length){tb.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:2rem">ChÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o</td></tr>';return;}
  tb.innerHTML=orders.map(o=>`<tr><td style="font-family:monospace">${o.id?.substring(0,8)}</td><td>${o.product}</td><td>${o.user}</td><td style="color:var(--accent)">${fmt(o.amount)}Ä‘</td><td><span class="badge badge-online">HoÃ n thÃ nh</span></td><td>${o.date}</td></tr>`).join('');
}

async function loadUsers(){
  const r=await fetch('/api/admin/users');
  const users=await r.json();
  const tb=document.getElementById('usersTable');
  if(!users.length){tb.innerHTML='<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:2rem">ChÆ°a cÃ³ ngÆ°á»i dÃ¹ng nÃ o</td></tr>';return;}
  tb.innerHTML=users.map(u=>`<tr><td><strong>${u.username}</strong></td><td>${u.email}</td><td style="font-family:monospace;color:var(--accent)">${fmt(u.balance||0)}Ä‘</td><td style="color:var(--muted)">${u.created_at}</td></tr>`).join('');
}

async function loadCategories(){
  const r=await fetch('/api/categories');
  categories=await r.json();
  const sel=document.getElementById('fCat');
  sel.innerHTML=categories.map(c=>`<option value="${c}">${c}</option>`).join('');
}

async function loadCatTable(){
  await loadCategories();
  document.getElementById('catTable').innerHTML=categories.map(c=>`
    <tr><td>${c}</td><td><button class="btn btn-danger btn-sm" onclick="deleteCategory('${c}')">XÃ³a</button></td></tr>`).join('');
}

async function addCategory(){
  const name=document.getElementById('catInput').value.trim();
  if(!name)return;
  await fetch('/api/admin/categories',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})});
  document.getElementById('catInput').value='';
  loadCatTable();
  showToast('âœ… ÄÃ£ thÃªm danh má»¥c');
}

async function deleteCategory(name){
  if(!confirm('XÃ³a danh má»¥c '+name+'?'))return;
  await fetch('/api/admin/categories/'+encodeURIComponent(name),{method:'DELETE'});
  loadCatTable();
  showToast('ğŸ—‘ï¸ ÄÃ£ xÃ³a danh má»¥c','warning');
}

function openAddModal(){
  document.getElementById('editId').value='';
  document.getElementById('modalTitle').textContent='ThÃªm sáº£n pháº©m má»›i';
  ['fName','fDesc','fImg','fFile'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('fPrice').value='0';
  document.getElementById('fSale').value='0';
  document.getElementById('fStock').value='-1';
  document.getElementById('fFeatured').value='0';
  document.getElementById('prodModal').classList.add('open');
}

function editProduct(id){
  const p=products.find(x=>x.id===id);
  if(!p)return;
  document.getElementById('editId').value=id;
  document.getElementById('modalTitle').textContent='Sá»­a sáº£n pháº©m';
  document.getElementById('fName').value=p.name;
  document.getElementById('fDesc').value=p.description;
  document.getElementById('fPrice').value=p.price;
  document.getElementById('fSale').value=p.sale_price||0;
  document.getElementById('fCat').value=p.category;
  document.getElementById('fType').value=p.type;
  document.getElementById('fImg').value=p.image||'';
  document.getElementById('fFile').value=p.file_url||'';
  document.getElementById('fStock').value=p.stock||-1;
  document.getElementById('fFeatured').value=p.featured?'1':'0';
  document.getElementById('prodModal').classList.add('open');
}

function closeModal(){document.getElementById('prodModal').classList.remove('open');}

async function saveProduct(){
  const id=document.getElementById('editId').value;
  const data={
    name:document.getElementById('fName').value,
    description:document.getElementById('fDesc').value,
    price:document.getElementById('fPrice').value,
    sale_price:document.getElementById('fSale').value,
    category:document.getElementById('fCat').value,
    type:document.getElementById('fType').value,
    image:document.getElementById('fImg').value,
    file_url:document.getElementById('fFile').value,
    stock:document.getElementById('fStock').value,
    featured:document.getElementById('fFeatured').value==='1'
  };
  if(!data.name){showToast('Vui lÃ²ng nháº­p tÃªn sáº£n pháº©m','error');return;}
  const url=id?`/api/admin/products/${id}`:'/api/admin/products';
  const method=id?'PUT':'POST';
  const r=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  const d=await r.json();
  if(d.ok){
    closeModal();
    loadProducts();
    showToast(id?'âœ… ÄÃ£ cáº­p nháº­t sáº£n pháº©m':'âœ… ÄÃ£ thÃªm sáº£n pháº©m má»›i');
  }
}

async function deleteProduct(id){
  if(!confirm('XÃ³a sáº£n pháº©m nÃ y?'))return;
  await fetch('/api/admin/products/'+id,{method:'DELETE'});
  loadProducts();
  showToast('ğŸ—‘ï¸ ÄÃ£ xÃ³a sáº£n pháº©m','warning');
}

function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.style.background=type==='success'?'#10b981':type==='warning'?'#f59e0b':'#ef4444';
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3000);
}

function fmt(n){return new Intl.NumberFormat('vi-VN').format(n);}

checkAuth();

async function loadMbSettings(){
  const r = await fetch('/api/admin/mb-settings');
  const s = await r.json();
  document.getElementById('mbEnabled').checked = s.enabled||false;
  document.getElementById('mbUsername').value = s.username||'';
  document.getElementById('mbAccount').value = s.account_number||'';
  document.getElementById('mbHolder').value = s.account_holder||'';
  document.getElementById('mbBankName').value = s.bank_name||'MB Bank';
  document.getElementById('mbPassword').value = '';

  const tr = await fetch('/api/admin/topup-requests');
  const list = await tr.json();
  const tbody = document.getElementById('topupTable');
  if(!list.length){ tbody.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--muted)">ChÆ°a cÃ³ yÃªu cáº§u</td></tr>'; return; }
  const statusLabel = s=>{
    if(s==='completed') return '<span style="color:#10b981;font-size:.75rem">âœ“ ThÃ nh cÃ´ng</span>';
    if(s==='pending') return '<span style="color:#fbbf24;font-size:.75rem">â³ Chá»</span>';
    return '<span style="color:#ef4444;font-size:.75rem">Háº¿t háº¡n</span>';
  };
  tbody.innerHTML = list.map(r=>`<tr>
    <td>${r.username}</td>
    <td style="font-family:monospace;font-size:.78rem">${r.code}</td>
    <td>${Number(r.amount).toLocaleString('vi')}Ä‘</td>
    <td>${r.xu_added?Number(r.xu_added).toLocaleString('vi')+' xu':'â€”'}</td>
    <td>${statusLabel(r.status)}</td>
    <td style="font-size:.75rem;color:var(--muted)">${r.created_at}</td>
  </tr>`).join('');
}

async function saveMbSettings(){
  const data = {
    enabled: document.getElementById('mbEnabled').checked,
    username: document.getElementById('mbUsername').value.trim(),
    password: document.getElementById('mbPassword').value,
    account_number: document.getElementById('mbAccount').value.trim(),
    account_holder: document.getElementById('mbHolder').value.trim(),
    bank_name: document.getElementById('mbBankName').value.trim()
  };
  const r = await fetch('/api/admin/mb-settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  const d = await r.json();
  if(d.ok) alert('âœ… ÄÃ£ lÆ°u cÃ i Ä‘áº·t MB Bank!');
  else alert('âŒ Lá»—i: '+(d.msg||''));
}

async function testMbConnection(){
  const el = document.getElementById('mbTestResult');
  el.style.display='block';
  el.style.background='rgba(255,255,255,.05)';
  el.textContent='ğŸ”„ Äang kiá»ƒm tra káº¿t ná»‘i...';
  const r = await fetch('/api/admin/mb-test');
  const d = await r.json();
  if(d.ok){
    el.style.background='rgba(16,185,129,.1)';
    el.style.border='1px solid rgba(16,185,129,.3)';
    el.style.color='#10b981';
    el.textContent='âœ… '+d.msg;
  } else {
    el.style.background='rgba(239,68,68,.1)';
    el.style.border='1px solid rgba(239,68,68,.3)';
    el.style.color='#ef4444';
    el.textContent='âŒ '+d.msg;
  }
}

</script>
</body>
</html>
